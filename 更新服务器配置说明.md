# 电脑鼠上位机 - 更新服务器配置说明

## 概述

更新检查功能会从服务器获取版本信息，支持两种格式：
1. **JSON格式（推荐）**：包含完整的版本信息、下载链接和更新说明
2. **纯文本格式**：简单的版本号格式

## 服务器访问地址

应用会优先访问：`{APP_URL}/version.json`，如果失败则尝试 `{APP_URL}/version.txt`

其中 `APP_URL` 在代码中定义为：`https://www.quartz.xin`

**注意**：推荐使用JSON格式，因为它支持更丰富的信息（下载链接、更新说明等）。

## 方案一：JSON格式（推荐）

### 文件位置
在服务器根目录创建文件：`version.json`

### 文件内容格式

```json
{
  "version": "2.0.2",
  "download_url": "https://www.quartz.xin/download/电脑鼠上位机2.0.2.exe",
  "release_notes": "新版本更新内容：\n- 修复了轨迹显示bug\n- 优化了界面性能\n- 添加了新功能"
}
```

### 字段说明

- **version**（必需）：最新版本号，格式为 `x.x.x`（如 `2.0.2`）
- **download_url**（可选）：新版本的下载链接，如果为空则使用 `APP_URL`
- **release_notes**（可选）：更新说明/发布日志，支持换行符 `\n`

### 完整示例

```json
{
  "version": "2.0.2",
  "download_url": "https://www.quartz.xin/download/电脑鼠上位机2.0.2.exe",
  "release_notes": "版本 2.0.2 更新内容：\n\n✨ 新功能：\n- 添加了轨迹回放功能\n- 新增数据导出功能\n\n🐛 修复：\n- 修复了串口连接稳定性问题\n- 修复了轨迹显示异常\n\n⚡ 优化：\n- 优化了界面响应速度\n- 改进了内存使用"
}
```

## 方案二：纯文本格式

### 文件位置
在服务器根目录创建文件：`version.txt`

### 文件内容格式

```
version: 2.0.2
```

或者：

```
2.0.2
```

**注意**：纯文本格式只支持版本号，不包含下载链接和更新说明。

## 服务器配置方法

### 方法一：静态文件服务器（最简单）

#### 1. Nginx 配置

在 `nginx.conf` 或站点配置文件中添加：

```nginx
server {
    listen 80;
    server_name www.quartz.xin;
    root /var/www/quartz.xin;
    index index.html;

    # 版本信息文件
    location /version.json {
        add_header Content-Type application/json;
        access_log off;
    }
    
    location /version.txt {
        add_header Content-Type text/plain;
        access_log off;
    }

    # 下载文件
    location /download/ {
        alias /var/www/quartz.xin/downloads/;
    }
}
```

#### 2. Apache 配置

在 `.htaccess` 或虚拟主机配置中添加：

```apache
# 设置JSON文件的Content-Type
<FilesMatch "version\.json$">
    Header set Content-Type "application/json; charset=utf-8"
</FilesMatch>

# 设置TXT文件的Content-Type
<FilesMatch "version\.txt$">
    Header set Content-Type "text/plain; charset=utf-8"
</FilesMatch>
```

### 方法二：使用 GitHub Pages（免费）

#### 步骤：

1. 在GitHub仓库中创建文件 `version.json`
2. 启用 GitHub Pages
3. 访问地址：`https://用户名.github.io/仓库名/version.json`

**示例 `version.json`：**
```json
{
  "version": "2.0.2",
  "download_url": "https://github.com/用户名/仓库名/releases/download/v2.0.2/电脑鼠上位机2.0.2.exe",
  "release_notes": "新版本发布！"
}
```

### 方法三：使用云存储（OSS/CDN）

#### 阿里云OSS配置：

1. 上传 `version.json` 到OSS Bucket
2. 设置文件为公共读
3. 获取文件的访问URL

#### 腾讯云COS配置：

1. 上传 `version.json` 到COS存储桶
2. 设置文件为公共读
3. 配置CDN加速（可选）

## 推荐的目录结构

```
服务器根目录/
├── index.html (网站首页)
├── version.json (或 version.txt)  ← 版本信息文件
└── download/                      ← 下载目录
    ├── 电脑鼠上位机2.0.1.exe
    ├── 电脑鼠上位机2.0.2.exe
    └── ...
```

## 高级配置：动态API接口

如果需要更灵活的版本管理，可以创建一个API接口：

### PHP示例

创建 `api/check_update.php`：

```php
<?php
header('Content-Type: application/json; charset=utf-8');

$version_info = [
    'version' => '2.0.2',
    'download_url' => 'https://www.quartz.xin/download/电脑鼠上位机2.0.2.exe',
    'release_notes' => "版本 2.0.2 更新内容：\n- 修复了轨迹显示bug\n- 优化了界面性能"
];

// 可选：从数据库读取
// $version_info = get_version_from_database();

echo json_encode($version_info, JSON_UNESCAPED_UNICODE | JSON_PRETTY_PRINT);
?>
```

然后修改代码中的 `version_url`：

```python
version_url = f"{APP_URL}/api/check_update.php"
```

### Node.js示例

```javascript
// check_update.js
const http = require('http');
const url = require('url');

const server = http.createServer((req, res) => {
    if (req.url === '/api/check_update') {
        const versionInfo = {
            version: '2.0.2',
            download_url: 'https://www.quartz.xin/download/电脑鼠上位机2.0.2.exe',
            release_notes: '版本 2.0.2 更新内容：\n- 修复了轨迹显示bug'
        };
        
        res.writeHead(200, {
            'Content-Type': 'application/json; charset=utf-8',
            'Access-Control-Allow-Origin': '*'
        });
        res.end(JSON.stringify(versionInfo));
    }
});

server.listen(80);
```

## 测试方法

### 1. 浏览器测试

直接在浏览器访问：
- `https://www.quartz.xin/version.json`
- `https://www.quartz.xin/version.txt`

应该能看到正确的JSON或文本内容。

### 2. 命令行测试

```bash
# 测试JSON格式
curl https://www.quartz.xin/version.json

# 测试文本格式
curl https://www.quartz.xin/version.txt
```

### 3. 应用内测试

在应用中点击"检查更新"按钮，观察是否正确获取版本信息。

## 注意事项

1. **文件编码**：确保文件使用 `UTF-8` 编码，避免中文乱码
2. **Content-Type**：确保服务器返回正确的Content-Type头
3. **HTTPS**：推荐使用HTTPS协议，保证安全性
4. **版本号格式**：使用语义化版本号（Semantic Versioning），如 `x.y.z`
5. **CORS**：如果使用跨域，可能需要配置CORS头
6. **缓存**：可以考虑设置适当的缓存策略，但要确保更新及时生效

## 快速开始（最简单的方法）

1. 在服务器根目录创建 `version.json` 文件
2. 填入以下内容：

```json
{
  "version": "2.0.2",
  "download_url": "https://www.quartz.xin/download/电脑鼠上位机2.0.2.exe",
  "release_notes": "新版本已发布"
}
```

3. 确保文件可公开访问
4. 在浏览器中测试访问 `https://www.quartz.xin/version.json`
5. 完成！

## 故障排查

### 问题1：无法获取版本信息

**检查项：**
- 文件是否存在且路径正确
- 文件权限是否正确（需要可读）
- 网络连接是否正常
- URL是否正确

### 问题2：JSON解析错误

**检查项：**
- JSON格式是否正确（可以使用在线JSON验证工具）
- 文件编码是否为UTF-8
- 是否有特殊字符需要转义

### 问题3：中文乱码

**解决方法：**
- 确保文件保存为UTF-8编码
- 服务器返回的Content-Type包含 `charset=utf-8`

## 更新流程示例

1. 发布新版本后，更新服务器上的 `version.json`
2. 用户点击"检查更新"按钮
3. 应用从服务器获取最新版本号
4. 与当前版本比较
5. 如果有新版本，提示用户下载

## 安全建议

1. 验证文件完整性（可选）：添加MD5或SHA256校验
2. 使用HTTPS协议
3. 限制访问频率（防止恶意请求）
4. 记录访问日志（用于分析）

---

**需要帮助？** 如有问题，请联系开发者：yinrui_shi@163.com

